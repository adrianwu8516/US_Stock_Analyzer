function collectInsiderTradingDataRecover(){
  var str = 'PDD-950064710,JD-913255864,SHOP-913254746,BIGC-950169639,WIX-913255788,EBAY-913256419,ETSY-913255993,W-913254679,OSTK-913257234,MELI-913323930,BZUN-913256015,JMIA-950117409,GOOG-913303964,AMZN-913256180,MSFT-913323997,VEEV-913254541,NET-950136918,FSLY-950122211,VMW-913324520,LLNW-913257149,AKAM-913256202,CRWD-950126602,FIVN-913255836,BL-913436338,IAC-913323689,INTU-913257560,UBER-950121423,LYFT-950116149,UPWK-950082315,FVRR-950126644,INFY-913323253,LMND-950166007,SSTK-913254436,ZM-950118595,TWLO-913254831,RNG-913254544,ADBE-913256192,ADSK-913256187,WORK-950122946,TEAM-913256077,DBX-925418496,NOW-913254427,WDAY-913254465,DDOG-950136998,ESTC-950082170,DT-950133159,PD-950117456,SPLK-913255699,AYX-925200015,ZS-925416316,DOCU-950052670,OKTA-925237190,SMAR-950052671,RNG-913254544,FTNT-913324222,MDB-925377113,ZUO-925419495,PEGA-913323427,AMBA-913255718,PSTG-913254790,TLND-913256118,ZEN-913254635,ZI-950157730,PYPL-913256043,SQ-913254798,FOUR-950164654,BILL-950147358,NCNO-950167490,STNE-950091058,RKT-950168855,TREE-913324161,AXP-913254990,MA-913255509,V-913324504,DFS-913255186,FISV-913256669,SE-925377978,BABA-913254558,TCEHY-925284100,BIDU-913256248,VNET-913255645,GDS-913437049,KC-950162480,SY-950121193,SINA-913323372,FUTU-950109882,TCOM-913256355,BEKE-950169866,DIS-913255192,NFLX-913257027,CMCSA-913256672,IQ-925418530,BILI-925418532,ROKU-925376726,SONO-950066677,SPOT-925418520,TME-950091606,TWTR-913254553,SNAP-925186755,FB-913303928,PINS-950118597,MTCH-913256072,MOMO-913255963,YY-913255724,HUYA-950053207,DOYU-950122558,WB-913255847,TWOU-913255832,BOXL-913904208,CHGG-913254548,LRN-913324634,EDU-913255230,TAL-913254311,CRM-913255140,HUBS-913254682,TTD-913431510,MGNI-913254607,OMC-913324055,LAMR-913257385,APPS-913253434,LMT-913255490,BA-913254998,RTX-913324503,GD-913255326,NOC-913323942,HEI-913255371,SPCE-950052430,AJRD-913255362,MAXR-950052426,DAL-913255171,UAL-913254883,ALK-913254942,AAL-913255803,LUV-913255501,SPR-913324358,SAVE-913255655,BKNG-925415331,EXPE-913256422,TRIP-913255688,MAR-913324072,HLT-913254584,CCL-913255078,MMYT-913255608,MGM-913323750,WYNN-913323857,LVS-913255505,AMD-913254235,NVDA-913257561,INTC-913257268,AVGO-913256091,QCOM-913323878,MU-913324077,XLNX-913323916,NXPI-913255610,TXN-913324096,ASML-913323243,SWKS-913323558,QRVO-913255987,MRVL-913324002,LITE-913256049,INSG-918493474,LRCX-913323461,GWPH-913303940,ACB-925299128,APHA-925338986,CGC-925307064,TLRY-950061378,CWBHF-950083917,MO-913323786,PM-913324165,XOM-913324585,PSX-913254430,CVX-913255163,RDS-A-925171048,RDS-B-925171049,OXY-913324070,ET-913255266,ATCO-913324371,ENPH-913255659,SEDG-913255936,GNRC-913324675,BLDP-913433680,PLUG-913254222,FSLR-913256740,SPWR-913257568,NEE-913255309,ORA-913324063,BEP-925377548,LOGI-913431426,AAPL-913256135,PI-913256114,IRBT-913323417,VICR-913323941,GPRO-913255887,WDC-913324101,STX-913323488,HQY-913255894,PPD-950153100,UNH-913324489,LH-913255482,TMO-913324439,MTBC-913253493,TDOC-913254759,LVGO-950131971,MCK-913323715,HCA-913254333,CNC-913255114,ALGN-913256164,MDXG-913253427,ILMN-913257257,NVTA-913254726,ISRG-913323418,VAPO-950096310,SRNE-913253457,PRSC-913323384,MRK-913323809,JNJ-913255443,AMGN-913256167,PFE-913324118,ABT-913254903,BIIB-913257034,DRRX-913256923,MRNA-950102542,VYGR-913256069,GILD-913256732,RDY-913324262,CRSP-913433908,BLUE-913255750,INO-913256124,T-913324397,VZ-913324525,TMUS-913324083,SFTBY-925309138,ERIC-913323378,NOK-913323953,COMM-913255786,CIEN-913254858,JNPR-913324636,IFNNY-925284005,RL-913324272,SHOO-913257543,ANF-913254953,AEO-913254913,GPS-913255347,LB-913255499,RVLV-950090181,TIF-913324430,TPR-913255125,DEO-913323349,LVMUY-925283767,RVLV-950090181,TJX-913324432,ROST-913257106,ATVI-913324154,EA-913257070,ZNGA-913255681,TTWO-913323524,NTES-913323367,TTWO-913323524,DKNG-950153166,PENN-913323450,PDYPY-925307862,YUM-913324591,QSR-916040727,DPZ-913255206,PZZA-913257579,MCD-913323709,CMG-913255105,CAKE-913256289,HSY-913255403,KO-913255465,PEP-913324114,MNST-913256773,FIZZ-913256608,SBUX-913257472,BYND-950104120,FMCI-950102446,K-913255450,USFD-913254827,TSN-913324457,SAM-913324298,BUD-913324648,STZ-913324379,NKE-913323915,UA-913324477,LULU-913323467,SKX-913324334,FL-913255297,HLF-913255382,WW-913324571,MED-913323730,PLNT-913254773,PTON-950138392,VFC-913324509,GRMN-913323374,COST-913256303,M-913255508,JWN-913255449,WMT-913324551,TGT-913324421,BBY-913255007,HD-913255369,LOW-913255495,CVNA-925284417,CHWY-950125342,DLTR-913256407,DG-913324660,AZO-913254995,TSLA-913255598,TM-913324437,HMC-913323530,F-913255275,FCAU-916040734,GM-913254303,APTV-913254381,SHLL-950122538,NIO-950076017,NIU-950088841,LI-950169475,GP-950155382,UNP-913324493,NSC-913323973,CSX-913324049,GE-913255327,DE-913255182,CAT-913255062,HON-913255392,MHK-913323756,DD-913255202,DOW-950118416,MMM-913323778,KEYS-913254701,FLIR-913256928,GLW-913255340,VSTO-913254727,GOLD-913730084,NEM-913323901,KL-925350364,JPM-913255447,C-913255055,BAC-913254999,USB-913324497,GS-913255353,MS-913323815,WFC-913324537,SCHW-913254872,ICE-913255415,CME-913256612,SPGI-913323760,AIG-913254929,HDB-913323515,IBN-913323570,CINF-913257332,PNC-913324172,SLM-913324088,CSCO-913256359,IBM-913255414,ORCL-913254891,INFY-913323253,SAP-913324299,CTSH-913256363,WNS-913324555,ANET-913254624,ADP-913256184,O-913324022,SPG-913324356,MAC-913255511,BPY-913254488,BAM-916040676,AMT-913254950,CCI-913255076,IIPR-925174192,STOR-913254706,WPC-913324556,REG-913324240,EPR-913255256,APTS-913254300,DHI-913255191,LOW-913255495,Z-913323060,NYMT-913324133,MFA-913323745,IVR-913324645,EQR-913255254,TOL-913324444,UPS-913324495,FDX-913255289,TFII-925307159,DADA-950164518,BEST-925372716,SCI-913324303,WM-913324550,CNK-913255115,AMC-913254559'
  CACHE.put("tickerPool", str, CACHELIFETIME);
}

function collectInsiderTradingData(){
  // Check if market closed
  if(!checkifClosed()) return;
  
  var poolCache = CACHE.get("tickerPool");
  Logger.log(poolCache)
  if (poolCache != null) {
    var poolLst = poolCache.split(',')
    while(poolLst[0] != ""){
      let ticker = poolLst.pop()
      CACHE.put("tickerPool", poolLst, CACHELIFETIME)
      let ticketId = ticker.split('-')[1]
      let ticketSymbol = ticker.split('-')[0]
      Logger.log(ticketSymbol + ": " + ticketId)
      collectInsiderTradingUnit(ticketSymbol, ticketId)
      collectInsiderTradingData()
      poolLst = [""]
    }
    insiderTradingMailer()
  }
}

function collectInsiderTradingUnit(ticketSymbol = 'DADA', tickerId = 950164518){
  let sleepDurationSec = 0.5
  let retry = 1
  while(retry < 2){
    try{
      let finalMetrix = []
      let today = new Date();
      let todayStr = String(today.getFullYear()) + "年" + String(today.getMonth() + 1).padStart(2, '0') + '月' + String(today.getDate()).padStart(2, '0') + '日';
      var insiderSheet = SpreadsheetApp.openById('1zraRLEJ-dfmBra21ZEizoXZIS6slKEHmj5uj9Xw-xhc')
      var listForSearch = insiderSheet.getSheetValues(2, 1, insiderSheet.getLastRow(), 1).flat()
      let url = 'https://securitiesapi.webullbroker.com/api/securities/stock/' + tickerId + '/holdersDetail?hasNum=0&pageSize=20&type=1'
      let xml = UrlFetchApp.fetch(url).getContentText();
      if(!xml.includes('},{')){Logger.log(ticketSymbol + ": No Data");return;}
      let insiderLst = xml.replace(/\[{|}\]/g,'').split('},{').map(item => JSON.parse("{" + item + "}"))
      for(let i in insiderLst){
        let insertId = (insiderLst[i].transactionDate + '-' + insiderLst[i].name + '-' + insiderLst[i].netAmount).hash()
        if(listForSearch.includes(insertId)){Logger.log(ticketSymbol + ": Data Existed");break;}
        insiderLst[i].netAmount = insiderLst[i].isAcquire == 1? insiderLst[i].netAmount : insiderLst[i].netAmount * -1
        finalMetrix.push([
          insertId, todayStr, ticketSymbol, insiderLst[i].transactionDate, 
          insiderLst[i].relationType, insiderLst[i].positionTitle, insiderLst[i].name, insiderLst[i].netAmount, insiderLst[i].price, insiderLst[i].postAmount])
      }
      if(finalMetrix.length!=0){
        insiderSheet.insertRowsAfter(1, finalMetrix.length)
        insiderSheet.getRange('A2:J' + (1+finalMetrix.length)).setValues(finalMetrix)
        return
      }else{
        return
      }
    }catch(e){
      Logger.log(e)
      Logger.log(ticketSymbol + " : Insider data parse failed " + retry)
      Utilities.sleep(sleepDurationSec * 1000 * retry)
      retry  += 1
    }
  }
}